<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>市场报告管理系统 - 管理后台</title>
    <style>
        /* Global reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #fdf2f8 0%, #f8f4ff 100%); /* Pink gradient background */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #374151; /* Main text color */
            min-height: 100vh;
        }

        /* Top admin bar styles */
        .admin-bar {
            background: linear-gradient(90deg, #f472b6 0%, #c084fc 100%); /* Gradient matching sidebar */
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            position: fixed; /* Fixed at top */
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1002; /* Ensure on top layer */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-status {
            background: #10b981; /* Online status green */
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .github-status {
            background: #6366f1;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        /* Navigation sidebar styles */
        .nav-sidebar {
            position: fixed;
            top: 44px; /* Offset from admin bar */
            left: 0;
            width: 260px;
            height: calc(100vh - 44px); /* Subtract admin bar height */
            background: linear-gradient(180deg, #f472b6 0%, #c084fc 100%); /* Pink to purple gradient */
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease; /* Smooth transition */
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        }

        .nav-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2); /* Light separator */
        }

        .nav-header h3 {
            color: white;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .nav-header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85em;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            padding: 15px 20px;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent; /* No border in inactive state */
            font-size: 0.95em;
            cursor: pointer;
            margin: 2px 0;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.15); /* Hover background */
            color: white;
            border-left-color: white; /* Hover left border */
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2); /* Active background */
            color: white;
            border-left-color: white; /* Active left border */
            font-weight: 600;
        }

        .nav-item .emoji {
            margin-right: 10px;
            font-size: 1.1em;
        }

        /* Mobile navigation toggle button styles */
        .nav-toggle {
            display: none; /* Hidden by default */
            position: fixed;
            top: 54px; /* Offset from admin bar */
            left: 20px;
            z-index: 1001; /* Higher than sidebar */
            background: #f472b6;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Main content area styles */
        .main-content {
            margin-left: 260px; /* Space for sidebar */
            margin-top: 44px; /* Space for admin bar */
            padding: 20px;
            min-height: calc(100vh - 44px); /* Subtract admin bar height */
        }

        .container {
            max-width: 1400px;
            margin: 0 auto; /* Center align */
        }

        /* Page header styles */
        .page-header {
            background: rgba(255, 255, 255, 0.8); /* Semi-transparent white background */
            backdrop-filter: blur(10px); /* Frosted glass effect */
            border-radius: 8px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Soft shadow */
            border-left: 4px solid #f472b6; /* Left border in theme color */
        }

        .page-header h1 {
            color: #ec4899; /* Theme pink */
            font-size: 1.8em;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .page-header p {
            color: #6b7280;
            font-size: 0.95em;
        }

        /* Page content area styles */
        .page-content {
            background: rgba(255, 255, 255, 0.8); /* Semi-transparent white background */
            backdrop-filter: blur(10px); /* Frosted glass effect */
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Soft shadow */
            min-height: 60vh;
        }

        .page-content.hidden {
            display: none; /* Hide inactive pages */
        }

        /* GitHub setup banner */
        .github-setup-banner {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .github-setup-banner.connected {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .setup-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setup-config {
            display: grid;
            gap: 15px;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .config-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        /* Common button styles */
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f472b6, #c084fc); /* Theme gradient */
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
            box-shadow: 0 4px 10px rgba(244, 114, 182, 0.3);
        }

        .btn-secondary {
            background: #6b7280; /* Gray */
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8em;
        }

        /* Latest report page styles */
        .latest-report-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .report-card-section {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-bottom: 25px;
        }

        .report-display {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .report-header-card {
            background: #f9fafb;
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Wrap for small screens */
            gap: 10px;
        }

        .report-info h3 {
            color: #1f2937;
            font-size: 1.3em;
            margin-bottom: 2px;
        }

        .report-info p {
            color: #6b7280;
            font-size: 0.9em;
        }

        .report-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .report-iframe {
            height: 600px; /* Report iframe height */
            border: none;
            width: 100%;
        }

        .no-report {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
            border: 1px dashed #e5e7eb;
            border-radius: 8px;
            background: rgba(255,255,255,0.5);
        }

        .no-report .icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* History reports page styles */
        .controls-section {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }

        .controls-row {
            display: flex;
            gap: 20px;
            align-items: flex-end; /* Align to bottom */
            flex-wrap: wrap; /* Wrap for small screens */
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 120px;
        }

        .form-group label {
            color: #374151;
            font-weight: 500;
            font-size: 0.9em;
        }

        .form-control {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9em;
            background: white;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: #f472b6;
            box-shadow: 0 0 0 3px rgba(244, 114, 182, 0.2);
        }

        /* Reports table styles */
        .reports-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .reports-table th,
        .reports-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .reports-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 0.9em;
        }

        .reports-table td {
            font-size: 0.9em;
            color: #6b7280;
        }

        .reports-table tr:hover {
            background: #fdf2f8; /* Hover background color */
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .status-available {
            background: #d1fae5; /* Green background */
            color: #065f46; /* Green text */
        }

        .status-missing {
            background: #fee2e2; /* Red background */
            color: #991b1b; /* Red text */
        }
        .status-na {
            background: #e0e7ff; /* Blue-ish background */
            color: #4338ca; /* Blue-ish text */
        }

        .table-actions {
            display: flex;
            gap: 5px;
        }

        /* Backup and download page styles */
        .admin-section {
            background: #fffbe6; /* Warning yellow background */
            border: 1px solid #fcd34d; /* Warning yellow border */
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 25px;
            color: #78350f; /* Warning text color */
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-section h4 {
            color: #b45309;
            margin: 0;
            font-size: 1.1em;
        }

        .admin-section p {
            margin: 0;
            font-size: 0.9em;
        }

        .upload-section {
            border: 2px dashed #f472b6; /* Theme color dashed border */
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.5); /* Semi-transparent background */
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .upload-section:hover {
            border-color: #ec4899;
            background: rgba(255, 255, 255, 0.8);
        }

        .upload-section.dragover {
            border-color: #ec4899;
            background: rgba(244, 114, 182, 0.1); /* Dragging background color */
        }

        #fileInput {
            display: none;
        }

        .management-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .management-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            cursor: pointer; /* Make cards clickable */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .management-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .management-card h4 {
            color: #1f2937;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .management-card p {
            color: #6b7280;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        /* File naming rules description */
        .naming-rules {
            background: #e0f2fe; /* Info blue background */
            border: 1px solid #90cdf4; /* Info blue border */
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #2b6cb0;
        }

        .naming-rules h4 {
            color: #2c5282;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .naming-rules ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .naming-rules li {
            margin: 8px 0;
            font-size: 0.9em;
        }

        .example-box {
            background: white;
            border: 1px solid #b3e5fc;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9em;
            overflow-x: auto; /* Prevent code overflow */
        }
        
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 2000; /* Higher than all content */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); /* Semi-transparent black background */
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 12px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            text-align: center;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content h3 {
            color: #ec4899;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .modal-content p {
            margin-bottom: 25px;
            color: #6b7280;
        }

        .modal-content input[type="password"] {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
        }

        .modal-content .btn {
            margin: 0 5px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loading indicator */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
            font-size: 1.2em;
            color: #374151;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f472b6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Statistics page specific styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .stat-card .icon {
            font-size: 3em;
            margin-bottom: 10px;
            color: #c084fc;
        }

        .stat-card h5 {
            font-size: 1.5em;
            color: #ec4899;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #6b7280;
            font-size: 0.9em;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .stats-table th,
        .stats-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9em;
            color: #374151;
        }

        .stats-table th {
            background: #f9fafb;
            font-weight: 600;
        }
        .stats-table tbody tr:hover {
            background: #fdf2f8;
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .nav-sidebar {
                transform: translateX(-100%); /* Hidden by default */
                box-shadow: none;
            }

            .nav-sidebar.open {
                transform: translateX(0); /* Show */
                box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            }

            .nav-toggle {
                display: block; /* Show mobile toggle button */
            }

            .main-content {
                margin-left: 0; /* Remove left margin */
                padding: 80px 15px 20px 15px; /* Adjust top and horizontal padding */
            }

            .admin-bar {
                padding: 10px 15px;
            }
            .admin-info span:last-child {
                display: none; /* Hide time */
            }

            .page-header, .page-content {
                padding: 15px; /* Adjust padding */
            }

            .controls-row {
                flex-direction: column; /* Vertical arrangement for filters */
                align-items: stretch;
            }

            .form-group {
                min-width: auto;
            }

            .reports-table {
                font-size: 0.8em; /* Smaller table font */
                display: block; /* Allow horizontal scrolling for table */
                overflow-x: auto;
                white-space: nowrap;
            }

            .management-grid {
                grid-template-columns: 1fr; /* Single column layout */
            }

            .report-display {
                margin: 0 -15px 25px -15px; /* Extend to edges */
                border-radius: 0;
                border-left: none;
                border-right: none;
            }

            .report-header-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .report-iframe {
                height: 400px; /* Mobile iframe height */
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .config-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Modal for admin authentication -->
    <div id="adminAuthModal" class="modal">
        <div class="modal-content">
            <h3>🔒 管理员验证</h3>
            <p>请输入管理员密码以继续操作。</p>
            <input type="password" id="adminPasswordInput" placeholder="请输入密码">
            <button class="btn btn-primary" onclick="checkAdminPassword()">确认</button>
            <button class="btn btn-secondary" onclick="closeAdminAuthModal()">取消</button>
        </div>
    </div>

    <!-- Loading indicator -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>正在处理，请稍候...</p>
        <p id="loadingMessage"></p>
    </div>

    <!-- Admin top bar -->
    <div class="admin-bar">
        <div class="admin-info">
            <span>📊 玫瑰-品类 报告管理系统</span>
            <span class="admin-status">管理员</span>
            <span class="github-status" id="githubStatus">GitHub未连接</span>
            <span>|</span>
            <span>当前时间: <span id="currentTime"></span></span>
        </div>
        <div>
            <span>数据更新: <span id="lastUpdate">2025-08-18</span></span>
        </div>
    </div>

    <!-- Navigation sidebar -->
    <nav class="nav-sidebar" id="navSidebar">
        <div class="nav-header">
            <h3>玫瑰-品类 报告管理面板</h3>
            <p>市场趋势报告管理</p>
        </div>
        <div class="nav-menu">
            <a href="#" class="nav-item active" data-page="latest">
                <span class="emoji">📄</span>最新报告
            </a>
            <a href="#" class="nav-item" data-page="history">
                <span class="emoji">📚</span>历史报告归档
            </a>
            <a href="#" class="nav-item" data-page="backup">
                <span class="emoji">🔧</span>备份和下载
            </a>
        </div>
    </nav>

    <!-- Mobile navigation toggle button -->
    <button class="nav-toggle" id="navToggle">☰</button>

    <!-- Main content area -->
    <div class="main-content">
        <div class="container">
            <!-- GitHub Setup Banner -->
            <div id="githubSetupBanner" class="github-setup-banner">
                <div class="setup-info">
                    <span style="font-size: 1.5em;">⚙️</span>
                    <div>
                        <strong>GitHub云端存储配置</strong>
                        <p style="margin: 0; font-size: 0.9em; opacity: 0.9;">配置GitHub仓库以实现云端存储和多用户同步</p>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="toggleGitHubSetup()">配置</button>
            </div>

            <!-- GitHub Configuration Section -->
            <div id="githubConfig" class="setup-config" style="display: none;">
                <h3 style="text-align: center; color: #374151; margin-bottom: 20px;">🔧 GitHub配置</h3>
                <div class="config-form">
                    <div class="form-group">
                        <label for="githubUsername">GitHub用户名</label>
                        <input type="text" id="githubUsername" class="form-control" placeholder="your-username">
                    </div>
                    <div class="form-group">
                        <label for="githubRepo">仓库名称</label>
                        <input type="text" id="githubRepo" class="form-control" placeholder="report-storage">
                    </div>
                    <div class="form-group">
                        <label for="githubToken">访问令牌</label>
                        <input type="password" id="githubToken" class="form-control" placeholder="ghp_xxxxxxxxxxxx">
                    </div>
                    <button class="btn btn-primary" onclick="connectGitHub()">🔗 连接GitHub</button>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 6px; border: 1px solid #0ea5e9; font-size: 0.9em; color: #0369a1;">
                    <strong>配置说明：</strong>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li>在GitHub创建私有仓库（建议名称：report-storage）</li>
                        <li>生成Personal Access Token，勾选repo权限</li>
                        <li>填写上述信息并点击连接</li>
                    </ol>
                </div>
            </div>

            <!-- Page header -->
            <div class="page-header">
                <h1 id="pageTitle">最新报告</h1>
                <p id="pageDescription">查看和管理当前最新发布的报告</p>
            </div>

            <!-- Latest report page -->
            <div id="latestPage" class="page-content">
                <div class="latest-report-container" id="latestReportsContainer">
                    <!-- Latest Market Trends Report -->
                    <div id="latestTrendsReportDisplay" class="no-report">
                        <div class="icon">📈</div>
                        <h3>暂无最新市场趋势报告</h3>
                        <p>请先上传当前月份的市场趋势HTML报告文件</p>
                        <button class="btn btn-primary" onclick="switchToAdminPage('backup')" style="margin-top: 15px;">
                            📤 去上传报告
                        </button>
                    </div>

                    <!-- Latest Market Data Report -->
                    <div id="latestDataReportDisplay" class="no-report" style="margin-top: 25px;">
                        <div class="icon">📊</div>
                        <h3>暂无最新市场数据月报</h3>
                        <p>请先上传当前月份的市场数据HTML报告文件</p>
                        <button class="btn btn-primary" onclick="switchToAdminPage('backup')" style="margin-top: 15px;">
                            📤 去上传报告
                        </button>
                    </div>
                </div>
            </div>

            <!-- History reports page -->
            <div id="historyPage" class="page-content hidden">
                <div class="controls-section">
                    <div class="controls-row">
                        <div class="form-group">
                            <label for="yearSelect">年份</label>
                            <select id="yearSelect" class="form-control" onchange="filterReports()">
                                <option value="all">全部</option>
                                <option value="2025" selected>2025年</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="monthSelect">月份</label>
                            <select id="monthSelect" class="form-control" onchange="filterReports()">
                                <option value="all">全部</option>
                                <option value="01">1月</option>
                                <option value="02">2月</option>
                                <option value="03">3月</option>
                                <option value="04">4月</option>
                                <option value="05">5月</option>
                                <option value="06">6月</option>
                                <option value="07" selected>7月</option>
                                <option value="08">8月</option>
                                <option value="09">9月</option>
                                <option value="10">10月</option>
                                <option value="11">11月</option>
                                <option value="12">12月</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="typeSelect">报告类型</label>
                            <select id="typeSelect" class="form-control" onchange="filterReports()">
                                <option value="all">全部</option>
                                <option value="market-trends">市场趋势报告</option>
                                <option value="market-data">市场数据月报</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-secondary" onclick="resetFilters()">重置筛选</button>
                        </div>
                    </div>
                </div>

                <table class="reports-table">
                    <thead>
                        <tr>
                            <th>报告名称</th>
                            <th>类型</th>
                            <th>日期</th>
                            <th>HTML状态</th>
                            <th>PDF状态</th>
                            <th>Excel状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        <!-- Report list will be dynamically generated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Backup and download page -->
            <div id="backupPage" class="page-content hidden">
                <div class="admin-section">
                    <span style="font-size: 1.5em;">⚠️</span>
                    <div>
                        <h4>管理员功能</h4>
                        <p>此页面仅限管理员操作，请确认您有相应权限后再进行操作。</p>
                    </div>
                </div>

                <div class="naming-rules">
                    <h4><span class="emoji">📋</span> 文件命名规范</h4>
                    <p><strong>为确保系统正确识别报告类型和月份，请按以下规范命名文件：</strong></p>
                    <ul>
                        <li><strong>市场趋势报告：</strong> <code>market-trends-YYYYMM.html</code> 或 <code>market-trends-YYYYMM.pdf</code></li>
                        <li><strong>市场数据月报：</strong> <code>market-data-YYYYMM.html</code> 或 <code>market-data-YYYYMM.xlsx</code> (或 .xls)</li>
                    </ul>
                    <div class="example-box">
                        <strong>示例：</strong><br>
                        <code>market-trends-202507.html</code> (2025年7月市场趋势报告的HTML版本)<br>
                        <code>market-data-202507.xlsx</code> (2025年7月市场数据月报的Excel版本)<br>
                        <code>market-trends-202507.pdf</code> (2025年7月市场趋势报告的PDF版本)
                    </div>
                    <p><strong>注意：</strong>文件名必须完全按照此格式，系统将自动解析文件类型和日期信息，并关联相同日期和类型的HTML、PDF或Excel文件。</p>
                </div>

                <div class="upload-section" onclick="triggerFileInput()" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <div style="font-size: 3em; margin-bottom: 15px;">📁</div>
                    <h3>上传报告文件</h3>
                    <p style="margin: 10px 0;">拖拽HTML, PDF或Excel文件到此处或点击选择文件</p>
                    <p style="font-size: 0.9em; color: #6b7280;">支持HTML, PDF, Excel格式，请按命名规范上传</p>
                    <p style="font-size: 0.8em; color: #dc2626; margin-top: 10px;">⚠️ 此功能需要管理员权限</p>
                    <button class="btn btn-primary" style="margin-top: 15px;">选择文件</button>
                </div>

                <input type="file" id="fileInput" accept=".html,.htm,.pdf,.xls,.xlsx" onchange="handleFileSelect(event)">

                <div class="management-grid">
                    <div class="management-card" onclick="showDownloadStats()">
                        <h4>📦 下载统计</h4>
                        <p>查看报告的下载趋势和统计数据。</p>
                        <button class="btn btn-secondary">查看统计</button>
                    </div>

                    <div class="management-card" onclick="showSystemStats()">
                        <h4>📊 系统统计</h4>
                        <p>查看系统存储统计和报告上传情况。</p>
                        <button class="btn btn-secondary">查看统计</button>
                    </div>

                    <div class="management-card" onclick="showFileManagement()">
                        <h4>🗑️ 文件管理</h4>
                        <p>管理已上传文件，支持删除和重新上传操作。</p>
                        <button class="btn btn-secondary">文件管理</button>
                    </div>
                </div>
            </div>

            <!-- Download Statistics Page -->
            <div id="downloadStatsPage" class="page-content hidden">
                <button class="btn btn-secondary" onclick="switchToAdminPage('backup')" style="margin-bottom: 20px;">
                    ⬅️ 返回备份和下载
                </button>
                <h2>📥 下载统计</h2>
                <p>此处显示报告的下载数据和趋势。</p>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon">📈</div>
                        <h5>总下载次数</h5>
                        <p id="totalDownloads">加载中...</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon">⭐</div>
                        <h5>最受欢迎报告</h5>
                        <p id="mostPopularReport">加载中...</p>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px; color: #ec4899;">最近下载记录</h3>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>报告名称</th>
                            <th>下载时间</th>
                            <th>下载类型</th>
                        </tr>
                    </thead>
                    <tbody id="downloadHistoryTableBody">
                        <!-- Download history will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- System Statistics Page -->
            <div id="systemStatsPage" class="page-content hidden">
                <button class="btn btn-secondary" onclick="switchToAdminPage('backup')" style="margin-bottom: 20px;">
                    ⬅️ 返回备份和下载
                </button>
                <h2>📊 系统统计</h2>
                <p>此处显示系统存储和文件上传的整体情况。</p>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon">📁</div>
                        <h5>报告总条目</h5>
                        <p id="totalReportsCount">加载中...</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon">⬆️</div>
                        <h5>已上传HTML报告</h5>
                        <p id="uploadedHtmlCount">加载中...</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon">⬇️</div>
                        <h5>已上传PDF报告</h5>
                        <p id="uploadedPdfCount">加载中...</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon">📄</div>
                        <h5>已上传Excel报告</h5>
                        <p id="uploadedExcelCount">加载中...</p>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px; color: #ec4899;">报告类型分布</h3>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>报告类型</th>
                            <th>HTML数量</th>
                            <th>PDF数量</th>
                            <th>Excel数量</th>
                        </tr>
                    </thead>
                    <tbody id="reportTypeStatsTableBody">
                        <!-- Report type statistics will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- File Management Page -->
            <div id="fileManagementPage" class="page-content hidden">
                <button class="btn btn-secondary" onclick="switchToAdminPage('backup')" style="margin-bottom: 20px;">
                    ⬅️ 返回备份和下载
                </button>
                <h2>🗑️ 文件管理</h2>
                <p>此处可以对已上传的报告文件进行管理，如删除或重新上传。</p>

                <h3 style="margin-top: 30px; margin-bottom: 15px; color: #ec4899;">所有已上传报告</h3>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>报告名称</th>
                            <th>类型</th>
                            <th>日期</th>
                            <th>上传时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="uploadedFilesTableBody">
                        <!-- Uploaded files list will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- Global variables and initialization ---
        // GitHub configuration
        let githubConfig = JSON.parse(localStorage.getItem('githubConfig')) || {};
        let isGitHubConnected = false;

        // Local storage fallback for reports data
        let reportsData = {};
        let downloadHistory = [];
        
        // Simulate admin password
        const ADMIN_PASSWORD = 'aroseisarose';

        // Page title and description data
        const pageInfo = {
            latest: { title: '最新报告', description: '查看和管理当前最新发布的报告' },
            history: { title: '历史报告归档', description: '查看和管理所有历史报告，支持筛选和下载' },
            backup: { title: '备份和下载', description: '管理员功能：上传新报告、文件管理和统计' },
            downloadStats: { title: '下载统计', description: '报告下载趋势和统计数据' },
            systemStats: { title: '系统统计', description: '系统存储和报告上传的整体情况' },
            fileManagement: { title: '文件管理', description: '管理已上传的报告文件，如删除或重新上传' }
        };

        // --- Execute when DOM is fully loaded ---
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            setupNavigation();
            checkGitHubConnection();
            loadReportsData();
            loadLatestReports();
            updateReportsTable();
        });

        // --- GitHub Configuration Functions ---
        function checkGitHubConnection() {
            if (githubConfig.username && githubConfig.repo && githubConfig.token) {
                isGitHubConnected = true;
                updateGitHubStatus('GitHub已连接');
                showConnectedBanner();
                loadReportsFromGitHub();
            } else {
                isGitHubConnected = false;
                updateGitHubStatus('GitHub未连接');
                loadReportsFromLocal(); // Fallback to local storage
            }
        }

        function updateGitHubStatus(status) {
            const statusElement = document.getElementById('githubStatus');
            statusElement.textContent = status;
            if (status.includes('已连接')) {
                statusElement.style.background = '#22c55e';
                statusElement.style.color = 'white';
            } else {
                statusElement.style.background = '#6366f1';
                statusElement.style.color = 'white';
            }
        }

        function showConnectedBanner() {
            const banner = document.getElementById('githubSetupBanner');
            banner.classList.add('connected');
            banner.innerHTML = `
                <div class="setup-info">
                    <span style="font-size: 1.5em;">✅</span>
                    <div>
                        <strong>GitHub云端存储已连接</strong>
                        <p style="margin: 0; font-size: 0.9em; opacity: 0.9;">仓库: ${githubConfig.username}/${githubConfig.repo}</p>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="toggleGitHubSetup()">重新配置</button>
            `;
        }

        function toggleGitHubSetup() {
            const configDiv = document.getElementById('githubConfig');
            if (configDiv.style.display === 'none') {
                configDiv.style.display = 'block';
                // Pre-fill existing values
                document.getElementById('githubUsername').value = githubConfig.username || '';
                document.getElementById('githubRepo').value = githubConfig.repo || '';
                document.getElementById('githubToken').value = githubConfig.token || '';
            } else {
                configDiv.style.display = 'none';
            }
        }

        async function connectGitHub() {
            const username = document.getElementById('githubUsername').value.trim();
            const repo = document.getElementById('githubRepo').value.trim();
            const token = document.getElementById('githubToken').value.trim();

            if (!username || !repo || !token) {
                alert('请填写所有必需的配置信息！');
                return;
            }

            showLoading('正在验证GitHub连接...');

            try {
                const response = await fetch(`https://api.github.com/repos/${username}/${repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok || response.status === 404) {
                    // Save configuration
                    githubConfig = { username, repo, token };
                    localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
                    
                    isGitHubConnected = true;
                    updateGitHubStatus('GitHub已连接');
                    showConnectedBanner();
                    document.getElementById('githubConfig').style.display = 'none';
                    
                    hideLoading();
                    alert('✅ GitHub连接成功！\n\n您现在可以开始使用云端存储功能了。');
                    
                    // Load reports from GitHub
                    await loadReportsFromGitHub();
                    loadLatestReports();
                    updateReportsTable();
                    
                } else if (response.status === 401) {
                    hideLoading();
                    alert('❌ 访问令牌无效！\n\n请检查令牌是否正确，并确保具有repo权限。');
                } else {
                    hideLoading();
                    alert('❌ 连接失败！\n\n请检查网络连接和配置信息。');
                }
            } catch (error) {
                hideLoading();
                alert('❌ 连接失败！\n\n' + error.message);
            }
        }

        // --- Data Loading Functions ---
        function loadReportsData() {
            if (isGitHubConnected) {
                loadReportsFromGitHub();
            } else {
                loadReportsFromLocal();
            }
        }

        function loadReportsFromLocal() {
            reportsData = JSON.parse(localStorage.getItem('reportsData')) || {};
            downloadHistory = JSON.parse(localStorage.getItem('downloadHistory')) || [];
        }

        async function loadReportsFromGitHub() {
            if (!isGitHubConnected) return;
            
            try {
                // Load reports index from GitHub
                const indexResponse = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/reports-index.json`, {
                    headers: { 'Authorization': `token ${githubConfig.token}` }
                });
                
                if (indexResponse.ok) {
                    const indexFile = await indexResponse.json();
                    const indexContent = atob(indexFile.content);
                    const data = JSON.parse(indexContent);
                    reportsData = data.reportsData || {};
                    downloadHistory = data.downloadHistory || [];
                } else {
                    // Initialize empty data if index doesn't exist
                    reportsData = {};
                    downloadHistory = [];
                }
                
                // Update last update time
                document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString();
                
            } catch (error) {
                console.error('Failed to load data from GitHub:', error);
                // Fallback to local storage
                loadReportsFromLocal();
            }
        }

        async function saveReportsToGitHub() {
            if (!isGitHubConnected) {
                // Fallback to local storage
                localStorage.setItem('reportsData', JSON.stringify(reportsData));
                localStorage.setItem('downloadHistory', JSON.stringify(downloadHistory));
                return;
            }
            
            try {
                const data = {
                    reportsData: reportsData,
                    downloadHistory: downloadHistory,
                    lastUpdate: new Date().toISOString()
                };
                
                const content = btoa(JSON.stringify(data, null, 2));
                
                // Check if index file exists
                let sha = null;
                try {
                    const existingFile = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/reports-index.json`, {
                        headers: { 'Authorization': `token ${githubConfig.token}` }
                    });
                    if (existingFile.ok) {
                        const fileData = await existingFile.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    // File doesn't exist, that's fine
                }
                
                // Update or create index file
                const updateResponse = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/reports-index.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Update reports index',
                        content: content,
                        ...(sha && { sha })
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error('Failed to save to GitHub');
                }
                
                // Update last update time
                document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString();
                
            } catch (error) {
                console.error('Failed to save to GitHub:', error);
                // Fallback to local storage
                localStorage.setItem('reportsData', JSON.stringify(reportsData));
                localStorage.setItem('downloadHistory', JSON.stringify(downloadHistory));
            }
        }

        // --- Keep all existing functions from the original system ---
        
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('zh-CN', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }

        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const navToggle = document.getElementById('navToggle');
            const navSidebar = document.getElementById('navSidebar');

            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');

                    if (['backup', 'downloadStats', 'systemStats', 'fileManagement'].includes(page)) {
                        if (sessionStorage.getItem('isAdminAuthenticated') === 'true') {
                            switchPage(page);
                        } else {
                            showAdminAuthModal(() => switchPage(page));
                        }
                    } else {
                        switchPage(page);
                    }

                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');

                    if (window.innerWidth <= 1024) {
                        navSidebar.classList.remove('open');
                    }
                });
            });

            navToggle.addEventListener('click', function() {
                navSidebar.classList.toggle('open');
            });

            document.querySelector('.main-content').addEventListener('click', function() {
                if (window.innerWidth <= 1024 && navSidebar.classList.contains('open')) {
                    navSidebar.classList.remove('open');
                }
            });
        }

        function switchPage(page) {
            document.querySelectorAll('.page-content').forEach(p => {
                p.classList.add('hidden');
            });

            const targetPage = document.getElementById(page + 'Page');
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }

            const info = pageInfo[page];
            if (info) {
                document.getElementById('pageTitle').textContent = info.title;
                document.getElementById('pageDescription').textContent = info.description;
            }

            if (page === 'downloadStats') {
                updateDownloadStats();
            } else if (page === 'systemStats') {
                updateSystemStats();
            } else if (page === 'fileManagement') {
                updateFileManagementList();
            } else if (page === 'history') {
                filterReports();
            } else if (page === 'latest') {
                loadLatestReports();
            }
        }

        // 新函数：需要管理员验证的页面跳转
        function switchToAdminPage(page) {
            if (sessionStorage.getItem('isAdminAuthenticated') === 'true') {
                switchPage(page);
                // 更新导航状态
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                const targetNavItem = document.querySelector(`.nav-item[data-page="${page}"]`) || 
                                    document.querySelector(`.nav-item[data-page="backup"]`); // 统计页面归属于backup
                if (targetNavItem) {
                    targetNavItem.classList.add('active');
                }
            } else {
                showAdminAuthModal(() => {
                    switchPage(page);
                    // 更新导航状态
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    const targetNavItem = document.querySelector(`.nav-item[data-page="${page}"]`) || 
                                        document.querySelector(`.nav-item[data-page="backup"]`); // 统计页面归属于backup
                    if (targetNavItem) {
                        targetNavItem.classList.add('active');
                    }
                });
            }
        }

        function showAdminAuthModal(callback) {
            const modal = document.getElementById('adminAuthModal');
            const passwordInput = document.getElementById('adminPasswordInput');
            passwordInput.value = '';
            modal.style.display = 'flex';
            modal.callback = callback;
        }

        function closeAdminAuthModal() {
            document.getElementById('adminAuthModal').style.display = 'none';
        }

        function checkAdminPassword() {
            const passwordInput = document.getElementById('adminPasswordInput');
            if (passwordInput.value === ADMIN_PASSWORD) {
                sessionStorage.setItem('isAdminAuthenticated', 'true');
                closeAdminAuthModal();
                if (document.getElementById('adminAuthModal').callback) {
                    document.getElementById('adminAuthModal').callback();
                }
            } else {
                alert('密码错误，请重新输入！');
                passwordInput.value = '';
            }
        }

        function showLoading(message = '正在执行操作...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function loadLatestReports() {
            // Clean up existing blob URLs
            cleanupBlobUrls();
            
            const now = new Date();
            const currentYearMonth = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}`;

            const latestTrendsReport = Object.values(reportsData)
                .filter(report => report.type === 'market-trends' && report.htmlUploaded)
                .sort((a, b) => {
                    const dateA = new Date(a.date.substring(0, 4), parseInt(a.date.substring(5, 7)) - 1);
                    const dateB = new Date(b.date.substring(0, 4), parseInt(b.date.substring(5, 7)) - 1);
                    return dateB - dateA;
                })[0];

            const latestDataReport = Object.values(reportsData)
                .filter(report => report.type === 'market-data' && report.htmlUploaded)
                .sort((a, b) => {
                    const dateA = new Date(a.date.substring(0, 4), parseInt(a.date.substring(5, 7)) - 1);
                    const dateB = new Date(b.date.substring(0, 4), parseInt(b.date.substring(5, 7)) - 1);
                    return dateB - dateA;
                })[0];

            renderReportCard('latestTrendsReportDisplay', latestTrendsReport, '📈 市场趋势报告', '趋势HTML报告', 'PDF', 'market-trends');
            renderReportCard('latestDataReportDisplay', latestDataReport, '📊 市场数据月报', '数据HTML报告', 'Excel', 'market-data');
        }

        function cleanupBlobUrls() {
            // 清理现有的blob URL以防止内存泄漏
            document.querySelectorAll('[data-blob-url]').forEach(element => {
                const blobUrl = element.dataset.blobUrl;
                if (blobUrl && blobUrl.startsWith('blob:')) {
                    URL.revokeObjectURL(blobUrl);
                }
                delete element.dataset.blobUrl;
            });
            
            // 清理iframe容器中的blob URL
            document.querySelectorAll('[id^="iframe-container-"]').forEach(container => {
                const blobUrl = container.dataset.blobUrl;
                if (blobUrl && blobUrl.startsWith('blob:')) {
                    URL.revokeObjectURL(blobUrl);
                }
                delete container.dataset.blobUrl;
            });
        }

        async function renderReportCard(elementId, report, defaultTitle, htmlTypeLabel, downloadFileType, reportType) {
            const displayElement = document.getElementById(elementId);
            
            if (report) {
                displayElement.innerHTML = `
                    <div class="report-display">
                        <div class="report-header-card">
                            <div class="report-info">
                                <h3>${report.title}</h3>
                                <p>上传日期: ${report.uploadTime ? report.uploadTime.split(' ')[0] : report.date} | 类型: ${report.type === 'market-trends' ? '市场趋势报告' : '市场数据月报'}</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn btn-primary" onclick="openReport('${report.key}')">
                                    👁️ 查看${htmlTypeLabel}
                                </button>
                                <button class="btn btn-secondary" ${report[downloadFileType.toLowerCase() + 'Uploaded'] ? '' : 'disabled'} onclick="downloadFile('${report.key}', '${downloadFileType.toLowerCase()}')">
                                    📄 下载${downloadFileType}
                                </button>
                            </div>
                        </div>
                        <div id="iframe-container-${report.key}" style="min-height: 600px; display: flex; align-items: center; justify-content: center; background: #f9fafb;">
                            <p>正在加载报告内容...</p>
                        </div>
                    </div>
                `;
                
                // Load content for iframe
                loadReportContent(report.key);
            } else {
                displayElement.innerHTML = `
                    <div class="no-report">
                        <div class="icon">${defaultTitle.includes('趋势') ? '📈' : '📊'}</div>
                        <h3>暂无最新${defaultTitle.replace(/.*\s/, '')}</h3>
                        <p>请先上传当前月份的${htmlTypeLabel}文件</p>
                        <button class="btn btn-primary" onclick="switchToAdminPage('backup')" style="margin-top: 15px;">
                            📤 去上传报告
                        </button>
                    </div>
                `;
            }
        }

        async function loadReportContent(reportKey) {
            const report = reportsData[reportKey];
            const container = document.getElementById(`iframe-container-${reportKey}`);
            
            if (!container || !report || !report.htmlUploaded) {
                if (container) {
                    container.innerHTML = '<p style="padding: 20px; text-align: center; color: #6b7280;">无法加载报告内容</p>';
                }
                return;
            }

            try {
                let htmlContent = '';
                
                if (isGitHubConnected && report.githubHtmlUrl) {
                    // 从GitHub获取内容，指定UTF-8编码
                    const response = await fetch(report.githubHtmlUrl);
                    if (response.ok) {
                        // 确保以UTF-8编码读取
                        const arrayBuffer = await response.arrayBuffer();
                        const decoder = new TextDecoder('utf-8');
                        htmlContent = decoder.decode(arrayBuffer);
                    } else {
                        throw new Error('Failed to fetch from GitHub');
                    }
                } else if (report.htmlContent) {
                    // 使用本地内容
                    htmlContent = report.htmlContent;
                } else {
                    throw new Error('No content available');
                }

                // 确保HTML内容包含正确的编码声明
                if (!htmlContent.includes('<meta charset=') && !htmlContent.includes('<meta http-equiv="Content-Type"')) {
                    // 如果没有编码声明，添加UTF-8编码声明
                    if (htmlContent.includes('<head>')) {
                        htmlContent = htmlContent.replace('<head>', '<head>\n<meta charset="UTF-8">');
                    } else if (htmlContent.includes('<html>')) {
                        htmlContent = htmlContent.replace('<html>', '<html>\n<head>\n<meta charset="UTF-8">\n</head>');
                    } else {
                        htmlContent = '<meta charset="UTF-8">\n' + htmlContent;
                    }
                }

                // 创建blob URL用于iframe
                const htmlBlob = new Blob([htmlContent], { type: 'text/html; charset=utf-8' });
                const blobUrl = URL.createObjectURL(htmlBlob);
                
                container.innerHTML = `<iframe class="report-iframe" src="${blobUrl}" frameborder="0"></iframe>`;
                
                // 存储用于清理
                container.dataset.blobUrl = blobUrl;
                
            } catch (error) {
                console.error('Failed to load report content:', error);
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #6b7280;">
                        <p>无法在此处预览报告</p>
                        <button class="btn btn-primary btn-sm" onclick="openReport('${reportKey}')" style="margin-top: 10px;">
                            🔗 在新窗口中打开
                        </button>
                    </div>
                `;
            }
        }

        function triggerFileInput() {
            // 检查管理员权限
            if (sessionStorage.getItem('isAdminAuthenticated') !== 'true') {
                showAdminAuthModal(() => {
                    document.getElementById('fileInput').click();
                });
                return;
            }
            document.getElementById('fileInput').click();
        }

        function handleFileSelect(event) {
            // 检查管理员权限
            if (sessionStorage.getItem('isAdminAuthenticated') !== 'true') {
                showAdminAuthModal(() => {
                    const file = event.target.files[0];
                    if (file) {
                        processUpload(file);
                    }
                });
                return;
            }
            
            const file = event.target.files[0];
            if (file) {
                processUpload(file);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            // 检查管理员权限
            if (sessionStorage.getItem('isAdminAuthenticated') !== 'true') {
                showAdminAuthModal(() => {
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        processUpload(files[0]);
                    }
                });
                return;
            }
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processUpload(files[0]);
            }
        }

        async function processUpload(file) {
            const fileName = file.name;
            
            const regex = /^(market-trends|market-data)-(\d{4})(\d{2})\.(html|htm|pdf|xls|xlsx)$/i; 
            const match = fileName.match(regex);
            
            if (!match) {
                alert('文件名格式错误或不支持的文件类型！\n\n请按照以下格式命名：\n• market-trends-YYYYMM.html 或 .pdf\n• market-data-YYYYMM.html 或 .xlsx (或 .xls)\n\n例如：market-trends-202507.html 或 market-data-202507.xlsx');
                return;
            }
            
            const [, type, year, month, extension] = match;
            const reportKey = `${type}-${year}${month}`;

            showLoading(`正在上传并处理文件: ${fileName}...`);

            try {
                // Initialize report entry if it doesn't exist
                if (!reportsData[reportKey]) {
                    reportsData[reportKey] = {
                        key: reportKey,
                        type: type,
                        title: `${year}年${parseInt(month)}月${type === 'market-trends' ? '市场趋势报告' : '市场数据月报'}`,
                        date: `${year}-${month}`,
                        htmlContent: null,
                        pdfContent: null,
                        excelContent: null,
                        htmlUploaded: false,
                        pdfUploaded: false,
                        excelUploaded: false,
                        downloads: 0, 
                        uploadTime: null,
                        githubHtmlUrl: null,
                        githubPdfUrl: null,
                        githubExcelUrl: null
                    };
                }

                // Read file content
                const fileContent = await readFileContent(file);
                
                // Store content and upload to GitHub if connected
                const lowerExtension = extension.toLowerCase();
                if (lowerExtension === 'html' || lowerExtension === 'htm') {
                    reportsData[reportKey].htmlContent = fileContent;
                    reportsData[reportKey].htmlUploaded = true;
                    
                    if (isGitHubConnected) {
                        const githubUrl = await uploadFileToGitHub(fileName, fileContent, 'text/html');
                        reportsData[reportKey].githubHtmlUrl = githubUrl;
                    }
                } else if (lowerExtension === 'pdf') {
                    reportsData[reportKey].pdfContent = fileContent;
                    reportsData[reportKey].pdfUploaded = true;
                    
                    if (isGitHubConnected) {
                        const githubUrl = await uploadFileToGitHub(fileName, fileContent, 'application/pdf');
                        reportsData[reportKey].githubPdfUrl = githubUrl;
                    }
                } else if (lowerExtension === 'xls' || lowerExtension === 'xlsx') {
                    reportsData[reportKey].excelContent = fileContent;
                    reportsData[reportKey].excelUploaded = true;
                    
                    if (isGitHubConnected) {
                        const githubUrl = await uploadFileToGitHub(fileName, fileContent, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
                        reportsData[reportKey].githubExcelUrl = githubUrl;
                    }
                }

                reportsData[reportKey].uploadTime = new Date().toLocaleString();
                
                // Save data
                await saveReportsToGitHub();
                
                hideLoading();
                alert(`✅ 文件上传成功！\n\n文件名: ${fileName}\n类型: ${type === 'market-trends' ? '市场趋势报告' : '市场数据月报'}\n日期: ${year}年${parseInt(month)}月`);
                
                // Refresh displays
                loadLatestReports();
                updateReportsTable();
                switchPage('latest');
                
            } catch (error) {
                hideLoading();
                alert('❌ 文件上传失败：' + error.message);
            }
        }

        async function uploadFileToGitHub(fileName, content, mimeType) {
            if (!isGitHubConnected) return null;
            
            try {
                let base64Content;
                if (typeof content === 'string' && mimeType === 'text/html') {
                    // 对于HTML文件，确保正确的UTF-8编码转换
                    const encoder = new TextEncoder();
                    const utf8Bytes = encoder.encode(content);
                    let binary = '';
                    utf8Bytes.forEach(byte => {
                        binary += String.fromCharCode(byte);
                    });
                    base64Content = btoa(binary);
                } else {
                    // 对于二进制文件，content应该已经是base64格式
                    base64Content = content.split(',')[1] || content;
                }
                
                const uploadPath = `reports/${fileName}`;
                
                // 检查文件是否存在
                let sha = null;
                try {
                    const existingFile = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${uploadPath}`, {
                        headers: { 'Authorization': `token ${githubConfig.token}` }
                    });
                    if (existingFile.ok) {
                        const fileData = await existingFile.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    // 文件不存在，没关系
                }
                
                const response = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${uploadPath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `Upload report: ${fileName}`,
                        content: base64Content,
                        ...(sha && { sha })
                    })
                });

                if (response.ok) {
                    const responseData = await response.json();
                    return responseData.content.download_url;
                } else {
                    throw new Error('GitHub upload failed');
                }
            } catch (error) {
                console.error('GitHub upload error:', error);
                return null;
            }
        }

        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                
                const lowerExtension = file.name.split('.').pop().toLowerCase();
                if (lowerExtension === 'pdf' || lowerExtension === 'xls' || lowerExtension === 'xlsx') {
                    reader.readAsDataURL(file);
                } else {
                    // 对于HTML文件，使用UTF-8编码读取
                    reader.readAsText(file, 'UTF-8');
                }
            });
        }

        function filterReports() {
            const year = document.getElementById('yearSelect').value;
            const month = document.getElementById('monthSelect').value;
            const type = document.getElementById('typeSelect').value;
            
            const tbody = document.getElementById('reportsTableBody');
            tbody.innerHTML = '';

            const allPossibleReports = {};
            const now = new Date();
            const startYear = 2024;
            const endYear = now.getFullYear() + 1;

            for (let y = startYear; y <= endYear; y++) {
                for (let m = 1; m <= 12; m++) {
                    const monthStr = String(m).padStart(2, '0');
                    const keyTrends = `market-trends-${y}${monthStr}`;
                    const keyData = `market-data-${y}${monthStr}`;

                    if (!reportsData[keyTrends]) {
                        reportsData[keyTrends] = {
                            key: keyTrends,
                            type: 'market-trends',
                            title: `${y}年${m}月市场趋势报告`,
                            date: `${y}-${monthStr}`,
                            htmlContent: null,
                            pdfContent: null,
                            excelContent: null,
                            htmlUploaded: false,
                            pdfUploaded: false,
                            excelUploaded: false,
                            downloads: 0,
                            uploadTime: null
                        };
                    }
                    allPossibleReports[keyTrends] = reportsData[keyTrends];

                    if (!reportsData[keyData]) {
                        reportsData[keyData] = {
                            key: keyData,
                            type: 'market-data',
                            title: `${y}年${m}月市场数据月报`,
                            date: `${y}-${monthStr}`,
                            htmlContent: null,
                            pdfContent: null,
                            excelContent: null,
                            htmlUploaded: false,
                            pdfUploaded: false,
                            excelUploaded: false,
                            downloads: 0,
                            uploadTime: null
                        };
                    }
                    allPossibleReports[keyData] = reportsData[keyData];
                }
            }

            const filteredAndSortedReports = Object.values(allPossibleReports)
                .filter(report => {
                    const reportYear = report.date.substring(0, 4);
                    const reportMonth = report.date.substring(5, 7);
                    
                    const matchYear = (year === 'all' || reportYear === year);
                    const matchMonth = (month === 'all' || reportMonth === month);
                    const matchType = (type === 'all' || report.type === type);
                    
                    const reportDate = new Date(reportYear, parseInt(reportMonth) - 1);
                    const currentDate = new Date(now.getFullYear(), now.getMonth());

                    if (reportDate > currentDate && !report.htmlUploaded && !report.pdfUploaded && !report.excelUploaded) {
                        return false;
                    }

                    return matchYear && matchMonth && matchType;
                })
                .sort((a, b) => {
                    const dateA = new Date(a.date.substring(0, 4), parseInt(a.date.substring(5, 7)) - 1);
                    const dateB = new Date(b.date.substring(0, 4), parseInt(b.date.substring(5, 7)) - 1);
                    return dateB - dateA;
                });

            if (filteredAndSortedReports.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px; color: #9ca3af;">没有找到匹配的报告。</td></tr>`;
                return;
            }

            filteredAndSortedReports.forEach(report => {
                const row = document.createElement('tr');
                row.setAttribute('data-year', report.date.substring(0, 4));
                row.setAttribute('data-month', report.date.substring(5, 7));
                row.setAttribute('data-type', report.type);
                
                const htmlStatusClass = report.htmlUploaded ? 'status-available' : 'status-missing';
                const htmlStatusText = report.htmlUploaded ? '已上传' : '未上传';
                
                const pdfStatusClass = report.pdfUploaded ? 'status-available' : 'status-missing';
                const pdfStatusText = report.pdfUploaded ? '已上传' : '未上传';

                const excelStatusClass = report.excelUploaded ? 'status-available' : (report.type === 'market-data' ? 'status-missing' : 'status-na');
                const excelStatusText = report.excelUploaded ? '已上传' : (report.type === 'market-data' ? '未上传' : 'N/A');

                const viewDisabled = report.htmlUploaded ? '' : 'disabled';
                
                let downloadButtonHtml;
                if (report.type === 'market-data') {
                    downloadButtonHtml = `<button class="btn btn-secondary btn-sm" ${report.excelUploaded ? '' : 'disabled'} onclick="downloadFile('${report.key}', 'excel')">下载</button>`;
                } else {
                    downloadButtonHtml = `<button class="btn btn-secondary btn-sm" ${report.pdfUploaded ? '' : 'disabled'} onclick="downloadFile('${report.key}', 'pdf')">下载</button>`;
                }

                row.innerHTML = `
                    <td>${report.title}</td>
                    <td>${report.type === 'market-trends' ? '市场趋势报告' : '市场数据月报'}</td>
                    <td>${report.date}</td>
                    <td><span class="status-badge ${htmlStatusClass}">${htmlStatusText}</span></td>
                    <td><span class="status-badge ${pdfStatusClass}">${pdfStatusText}</span></td>
                    <td><span class="status-badge ${excelStatusClass}">${excelStatusText}</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" ${viewDisabled} onclick="openReport('${report.key}')">查看</button>
                            ${downloadButtonHtml}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function resetFilters() {
            document.getElementById('yearSelect').value = 'all';
            document.getElementById('monthSelect').value = 'all';
            document.getElementById('typeSelect').value = 'all';
            filterReports();
        }

        function updateReportsTable() {
            filterReports();
        }

        async function openReport(reportKey) {
            const report = reportsData[reportKey];
            if (report && report.htmlUploaded) {
                try {
                    let htmlContent = '';
                    
                    if (isGitHubConnected && report.githubHtmlUrl) {
                        // 从GitHub获取内容
                        showLoading('正在从GitHub加载报告...');
                        const response = await fetch(report.githubHtmlUrl);
                        if (response.ok) {
                            // 确保以UTF-8编码读取
                            const arrayBuffer = await response.arrayBuffer();
                            const decoder = new TextDecoder('utf-8');
                            htmlContent = decoder.decode(arrayBuffer);
                        } else {
                            throw new Error('Failed to fetch from GitHub');
                        }
                        hideLoading();
                    } else if (report.htmlContent) {
                        // 使用本地内容
                        htmlContent = report.htmlContent;
                    } else {
                        throw new Error('No content available');
                    }

                    // 确保HTML内容包含正确的编码声明
                    if (!htmlContent.includes('<meta charset=') && !htmlContent.includes('<meta http-equiv="Content-Type"')) {
                        // 如果没有编码声明，添加UTF-8编码声明
                        if (htmlContent.includes('<head>')) {
                            htmlContent = htmlContent.replace('<head>', '<head>\n<meta charset="UTF-8">');
                        } else if (htmlContent.includes('<html>')) {
                            htmlContent = htmlContent.replace('<html>', '<html>\n<head>\n<meta charset="UTF-8">\n</head>');
                        } else {
                            htmlContent = '<meta charset="UTF-8">\n' + htmlContent;
                        }
                    }

                    // 创建blob URL并在新窗口中打开
                    const htmlBlob = new Blob([htmlContent], { type: 'text/html; charset=utf-8' });
                    const htmlBlobUrl = URL.createObjectURL(htmlBlob);
                    const newWindow = window.open(htmlBlobUrl, '_blank', 'width=1200,height=800');
                    newWindow.onbeforeunload = () => URL.revokeObjectURL(htmlBlobUrl);
                    
                } catch (error) {
                    hideLoading();
                    console.error('Failed to open report:', error);
                    alert('无法打开报告，请检查网络连接或稍后重试。');
                }
            } else {
                alert('该报告的HTML版本尚未上传，无法查看！');
            }
        }

        async function downloadFile(reportKey, fileType) {
            const report = reportsData[reportKey];
            let content;
            let mimeType;
            let fileNameSuffix;
            let uploadedStatus;
            let githubUrl;

            if (fileType === 'pdf') {
                content = report.pdfContent;
                mimeType = 'application/pdf';
                fileNameSuffix = '.pdf';
                uploadedStatus = report.pdfUploaded;
                githubUrl = report.githubPdfUrl;
            } else if (fileType === 'excel') {
                content = report.excelContent;
                mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                fileNameSuffix = '.xlsx';
                uploadedStatus = report.excelUploaded;
                githubUrl = report.githubExcelUrl;
            } else {
                alert('不支持的下载文件类型。');
                return;
            }

            if (report && uploadedStatus) {
                // Increment download count
                reportsData[reportKey].downloads = (reportsData[reportKey].downloads || 0) + 1;
                downloadHistory.push({
                    reportKey: reportKey,
                    title: report.title,
                    timestamp: new Date().toLocaleString(),
                    type: fileType.toUpperCase()
                });
                
                await saveReportsToGitHub();

                // Download file
                let downloadUrl;
                if (isGitHubConnected && githubUrl) {
                    downloadUrl = githubUrl;
                } else {
                    downloadUrl = content;
                }
                
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `${report.title.replace(/\s+/g, '')}${fileNameSuffix}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                if (document.getElementById('downloadStatsPage') && !document.getElementById('downloadStatsPage').classList.contains('hidden')) {
                    updateDownloadStats();
                }

            } else {
                alert(`该报告的${fileType.toUpperCase()}版本尚未上传，无法下载！`);
            }
        }

        function showDownloadStats() {
            switchPage('downloadStats');
            updateDownloadStats();
        }

        function updateDownloadStats() {
            const totalDownloadsElement = document.getElementById('totalDownloads');
            const mostPopularReportElement = document.getElementById('mostPopularReport');
            const downloadHistoryTableBody = document.getElementById('downloadHistoryTableBody');

            let totalDownloads = 0;
            for (const key in reportsData) {
                totalDownloads += (reportsData[key].downloads || 0);
            }
            totalDownloadsElement.textContent = totalDownloads;

            let maxDownloads = -1;
            let popularReportTitle = '无';
            for (const key in reportsData) {
                if (reportsData[key].downloads > maxDownloads) {
                    maxDownloads = reportsData[key].downloads;
                    popularReportTitle = reportsData[key].title;
                }
            }
            mostPopularReportElement.textContent = popularReportTitle === '无' ? '尚无下载' : `${popularReportTitle} (${maxDownloads} 次)`;

            downloadHistoryTableBody.innerHTML = '';
            if (downloadHistory.length === 0) {
                downloadHistoryTableBody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 20px; color: #9ca3af;">尚无下载记录。</td></tr>`;
            } else {
                const sortedHistory = [...downloadHistory].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                sortedHistory.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.title}</td>
                        <td>${record.timestamp}</td>
                        <td>${record.type}</td>
                    `;
                    downloadHistoryTableBody.appendChild(row);
                });
            }
        }

        function showSystemStats() {
            switchPage('systemStats');
            updateSystemStats();
        }

        function updateSystemStats() {
            const totalReportsCountElement = document.getElementById('totalReportsCount');
            const uploadedHtmlCountElement = document.getElementById('uploadedHtmlCount');
            const uploadedPdfCountElement = document.getElementById('uploadedPdfCount');
            const uploadedExcelCountElement = document.getElementById('uploadedExcelCount');
            const reportTypeStatsTableBody = document.getElementById('reportTypeStatsTableBody');

            const allReportsArray = Object.values(reportsData);
            const totalReportKeys = allReportsArray.length;
            const htmlUploadedCount = allReportsArray.filter(r => r.htmlUploaded).length;
            const pdfUploadedCount = allReportsArray.filter(r => r.pdfUploaded).length;
            const excelUploadedCount = allReportsArray.filter(r => r.excelUploaded).length;

            totalReportsCountElement.textContent = totalReportKeys;
            uploadedHtmlCountElement.textContent = htmlUploadedCount;
            uploadedPdfCountElement.textContent = pdfUploadedCount;
            uploadedExcelCountElement.textContent = excelUploadedCount;

            const typeStats = {
                'market-trends': { html: 0, pdf: 0, excel: 0 },
                'market-data': { html: 0, pdf: 0, excel: 0 }
            };
            allReportsArray.forEach(report => {
                if (report.htmlUploaded && typeStats[report.type]) {
                    typeStats[report.type].html++;
                }
                if (report.pdfUploaded && typeStats[report.type]) {
                    typeStats[report.type].pdf++;
                }
                if (report.excelUploaded && typeStats[report.type]) {
                    typeStats[report.type].excel++;
                }
            });

            reportTypeStatsTableBody.innerHTML = '';
            for (const typeKey in typeStats) {
                const row = document.createElement('tr');
                const typeName = typeKey === 'market-trends' ? '市场趋势报告' : '市场数据月报';
                row.innerHTML = `
                    <td>${typeName}</td>
                    <td>${typeStats[typeKey].html}</td>
                    <td>${typeStats[typeKey].pdf}</td>
                    <td>${typeStats[typeKey].excel}</td>
                `;
                reportTypeStatsTableBody.appendChild(row);
            }
        }

        function showFileManagement() {
            switchPage('fileManagement');
            updateFileManagementList();
        }

        function updateFileManagementList() {
            const uploadedFilesTableBody = document.getElementById('uploadedFilesTableBody');
            uploadedFilesTableBody.innerHTML = '';

            const uploadedReports = Object.values(reportsData).filter(r => r.htmlUploaded || r.pdfUploaded || r.excelUploaded);

            if (uploadedReports.length === 0) {
                uploadedFilesTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px; color: #9ca3af;">尚无已上传的文件。</td></tr>`;
            } else {
                uploadedReports.sort((a, b) => new Date(b.uploadTime || 0) - new Date(a.uploadTime || 0));

                uploadedReports.forEach(report => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${report.title}</td>
                        <td>${report.type === 'market-trends' ? '市场趋势报告' : '市场数据月报'}</td>
                        <td>${report.date}</td>
                        <td>${report.uploadTime || 'N/A'}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="deleteReport('${report.key}')">删除</button>
                        </td>
                    `;
                    uploadedFilesTableBody.appendChild(row);
                });
            }
        }

        async function deleteReport(reportKey) {
            if (confirm(`确定要删除报告 "${reportsData[reportKey].title}" 吗？\n\n此操作将删除所有HTML、PDF和Excel版本的数据。`)) {
                delete reportsData[reportKey];
                
                downloadHistory = downloadHistory.filter(record => record.reportKey !== reportKey);
                await saveReportsToGitHub();

                alert('报告已删除。');
                updateFileManagementList();
                loadLatestReports();
                updateReportsTable();
                updateDownloadStats();
                updateSystemStats();
            }
        }
    </script>
</body>
</html>